events {}

http {
  # ----------------------------
  # ① Rate Limit（開発はゆるめ）
  # ----------------------------
  limit_req_zone $binary_remote_addr zone=dev_limit:10m rate=10r/s;

  # ----------------------------
  # ② POST サイズ制限（DoS対策）
  # ----------------------------
  client_max_body_size 2M;

  server {
    listen 80;
    server_name localhost;

    # ----------------------------
    # ③ 不要な HTTP メソッド拒否
    # ----------------------------
    if ($request_method !~ ^(GET|POST|PATCH|DELETE|OPTIONS)$ ) {
        return 405;
    }

    location / {
      # ① レートリミットの適用
      limit_req zone=dev_limit burst=20 nodelay;

      # ④ Proxy 設定
      proxy_pass http://spike-message-board-backend:3001;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;

      # ⑤ 情報漏洩を防ぐ Nginx のデフォルトヘッダ抑制
      proxy_hide_header X-Powered-By;
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
    }
  }
}
